---
sidebar_position: 3
---

# Using common services

## Email

### SMTP

SMTP usually runs on port 25, 265(ssl), and 587(ssl), but of course it could run on any other port. If you find a port running SMTP, you can connect and login to it using:

```bash
# connecting
telnet <IP> 25

# authenticate with username password (will be prompted)
AUTH

# Tell the server your domain name
EHLO <domain>   # ex: EHLO the-nest.com

# to send a letter, ex: from crystal to steven
MAIL FROM crystal@the-nest.com
RCPT TO steven@the-nest.com
DATA
....type your stuff here....
EOF     # to indicate that your message is completed
```

You don't always need authentication to use the SMTP service, so it's likely that you can send emails or issue other commands without valid credentials.

You can enumerate usernames with some commands:

```bash
# VRFY
VRFY root
250 Super-User <root@myhost>
VRFY blah
550 blah... User unknown

# EXPN
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 <ed.williams@myhost>
EXPN sshd
250 2.1.5 sshd privsep <sshd@mail2>

# RCPT TO
MAIL FROM:test@test.org
250 2.1.0 test@test.org... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```

### POP

POP usually runs on port 110 and 995(ssl). It allows you to fetch and retrieve emails. The messages arestored on the client machine and deleted from the server. 

The basic commands are:

```bash
# connecting
telnet <IP> 110

# login
user <username>
pass <password>

# get capabilities
capa

# list emails
list

# read emails of index
retr 1  # first email
retr 2

# delete emails of index
dele 1

# exit and close connection
quit
```

### IMAP

IMAP uses port 143 and 993(ssl). Similar to POP, this service allows you to retrieve received email. Contrary to POP though, you aren't downloading or storing messages to your system. You're actually reading the information from the server itself, so this protocol allows you to access your mails from multiple devices simultaneously.

The basic commands are:

```bash
# connecting
telnet <IP> 143

# login, use quotes around strings if it contains spaces of othe special chars
A1 LOGIN <username> <password>

# list folder and mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *

# create/delete folders/mailboxes
A1 CREATE INBOX.Archive.2012
A1 DELETE "To Read"

# select mailbox
A1 SELECT INBOX

# list messages, FLAGS can be defined for mailboxes and will be given from SELECT command
# system-defined flags are: Seen, Answered, Flagged, Deleted, Draft, Recent
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)

# Retrieve Message Content
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])

# close mailbox
A1 CLOSE

# logout and close connection
A1 LOGOUT
```

## LDAP

> LDAP (Lightweight Directory Access Protocol) is a software protocol for enabling anyone to locate organizations, individuals, and other resources such as files and devices in a network, whether on the public Internet or on a corporate intranet.

Think of it as a tree structure for the entire organization.

Enumeration with [python](https://book.hacktricks.xyz/pentesting/pentesting-ldap#basic-enumeration) or with ldapsearch:

```bash
# without creds
ldapsearch -x -h <IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

# with creds
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

# with creds, kerberos instead of NTLM
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -Y GSSAPI -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

```
When you have creds, you can try to dump data, change `CN` for different info:
```bash
# Commonly used CN values
# CN=Users              -> extract users
# CN=Computers          -> extract computers
# CN=<MY NAME>          -> extract my info
# CN=Domain Admins      -> extract domain admins
# CN=Domain Users       -> extract domain users
# CN=Enterprise Admins  -> extract enterprise admins
# CN=Administrators     -> extract Administrators
# CN=Remote Desktop Users   -> extract RDP users

ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<CN>,DC=<1_SUBDOMAIN>,DC=<TLD>"
```

Dump everything
```bash
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
# -x Simple Authentication
# -h LDAP Server
# -D My User
# -w My password
# -b Base site, all data from here will be given
```

## WSMAN

WinRM (Windows Remote Management) is the Microsoft implementation of WS-Management Protocol. It's usually in a higher port(5985, 5986), so if you don't run `-p-` nmap by default will not find it since it's not in the top 1000 common ports. But if you have creds this gives an awesome shell!

For WinRM hacking, use [evil-winrm](https://github.com/Hackplayers/evil-winrm).

Usage:
```bash
# powersploit in /usr/share/windows-resources/powersploit/Exfiltration

# if you want to load powershell scripts, supply the -s option
evil-winrm -i 10.10.10.149 -u SUPPORTDESK\\chase -s ~/pshs/ -p 'Q4)sJu\Y8qz*A3?d'

# if you want to load executables, supply the -e option
evil-winrm -i 10.10.10.149 -u SUPPORTDESK\\chase -e ~/execs/ -p 'Q4)sJu\Y8qz*A3?d'

# you can upload/download any files inside shell
upload <filename>
download <filename>
```